pipeline {
  agent any

  environment {
    MAVEN_OPTS = "-Dmaven.repo.local=.m2/repository"
  }

  parameters {
    choice(name: 'JAVA_VERSION', choices: ['17', '21'], description: 'Java version to test with')
  }

  tools {
    jdk "${params.JAVA_VERSION}"
    maven 'Maven 3.9' // Name from Jenkins tool config
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://your-git-repo.git', branch: 'main'
      }
    }

    stage('Cache Maven Repo') {
      steps {
        sh 'mkdir -p .m2/repository'
      }
    }

    stage('Compile') {
      steps {
        sh 'mvn clean compile'
      }
    }

    stage('Unit Tests') {
      steps {
        sh 'mvn test'
      }
    }

    stage('Package JAR') {
      steps {
        sh 'mvn package -DskipTests'
      }
    }

    stage('Archive Artifact') {
      steps {
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
      }
    }

    stage('Optional: Deploy to Nexus') {
      when {
        expression { return env.BRANCH_NAME == 'main' }
      }
      steps {
        // Requires Maven settings with credentials
        sh 'mvn deploy -s settings.xml'
      }
    }
  }

  post {
    always {
      junit '**/target/surefire-reports/*.xml'
      cleanWs()
    }
  }
}
